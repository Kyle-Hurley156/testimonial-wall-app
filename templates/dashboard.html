<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Smart Secure Reviews</title>
    <style>
        :root {
            --primary-color: #4338ca;
            --primary-hover: #3730a3;
            --secondary-color: #e2e8f0;
            --secondary-hover: #cbd5e1;
            --danger-color: #dc2626;
            --danger-hover: #b91c1c;
            --success-color: #16a34a;
            --success-hover: #15803d;
            --warning-color: #f59e0b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            font-size: 16px;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .dashboard-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            background-color: var(--card-bg);
            padding: 15px 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .header-title {
            font-size: 1.75em;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9em;
            font-weight: 600;
            transition: background-color 0.2s;
            text-align: center;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--secondary-hover); }
        .btn-logout { background-color: var(--danger-color); color: white; }
        .btn-logout:hover { background-color: var(--danger-hover); }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .card h2 {
            margin-top: 0;
            font-size: 1.25em;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            font-size: 1em;
            background-color: #f8fafc;
        }
        
        .input-group {
            display: flex;
        }
        .input-group .form-control {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .input-group .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .testimonial-card {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .testimonial-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;}
        .author-info { display: flex; flex-direction: column; }
        .author-name { font-size: 1.1em; font-weight: 600; }
        .stars { color: var(--warning-color); font-size: 1.1em; }
        .status { padding: 5px 10px; border-radius: 99px; font-size: 0.8em; font-weight: 600; text-transform: uppercase; }
        .status-pending { background-color: #fef9c3; color: #a16207; }
        .status-approved { background-color: #dcfce7; color: #166534; }
        .status-hidden { background-color: #f1f5f9; color: #475569; }
        .testimonial-content { color: var(--text-secondary); line-height: 1.6; margin-bottom: 15px; }
        .actions { display: flex; flex-wrap: wrap; gap: 10px; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--card-bg); margin: auto; padding: 30px;
            border: 1px solid var(--border-color); width: 90%; max-width: 600px;
            border-radius: 12px; position: relative;
        }
        .close-button {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
            position: absolute; top: 10px; right: 20px;
        }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-content h2 { margin-top: 0;}
        .modal-content ol { padding-left: 20px; line-height: 1.7; color: var(--text-secondary); }

    </style>
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <h1 class="header-title">Dashboard</h1>
            <div class="header-actions">
                <button id="embed-btn" class="btn btn-secondary">How to Embed</button>
                {% if current_user.subscription_status == 'active' %}
                <a href="{{ url_for('manage_subscription') }}" class="btn btn-secondary">Manage Billing</a>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="btn btn-logout">Log Out</a>
            </div>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if current_user.subscription_status == 'inactive' %}
        <div class="card">
            <h2>Activate Your Account</h2>
            <p>Subscribe now to display your testimonials and get your public wall link.</p>
            <a href="{{ url_for('create_checkout_session') }}" class="btn btn-primary">Subscribe Now</a>
            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 25px 0;">
            <h2>Have a Code?</h2>
            <form action="{{ url_for('redeem_code') }}" method="POST">
                <div class="form-group input-group">
                    <input type="text" name="promo_code" class="form-control" placeholder="Enter your code" required>
                    <button type="submit" class="btn btn-secondary">Redeem</button>
                </div>
            </form>
        </div>
        {% endif %}

        {% if current_user.subscription_status in ['active', 'lifetime'] %}
        <div class="card">
            <h2>Your Links</h2>
            <div class="form-group">
                <label for="collection-link" class="form-label">Your Collection Link (Share this with clients)</label>
                <div class="input-group">
                    <input type="text" id="collection-link" class="form-control" value="{{ url_for('collect_testimonial_page', user_id=current_user.id, _external=True) }}" readonly>
                    <button class="btn btn-secondary" onclick="copyToClipboard('collection-link')">Copy</button>
                </div>
            </div>
            <div class="form-group">
                <label for="wall-link" class="form-label">Your Public Wall URL</label>
                <div class="input-group">
                    <input type="text" id="wall-link" class="form-control" value="{{ url_for('show_wall', user_id=current_user.id, _external=True) }}" readonly>
                    <button class="btn btn-secondary" onclick="copyToClipboard('wall-link')">Copy</button>
                </div>
            </div>
        </div>
        {% endif %}

        {% if current_user.subscription_status == 'lifetime' %}
        <div class="card">
            <h2>Lifetime Access Unlocked!</h2>
            <p style="color: var(--text-secondary); margin: 0;">You have free, unlimited access to Smart Secure Reviews.</p>
        </div>
        {% endif %}
        
        <div class="card">
            <h2>Wall Settings</h2>
            <form action="{{ url_for('update_wall_settings') }}" method="POST">
                <div class="form-group">
                    <label for="wall_title" class="form-label">Custom Wall Title</label>
                    <input type="text" id="wall_title" name="wall_title" class="form-control" value="{{ current_user.wall_title }}" placeholder="e.g., What Our Customers Say">
                </div>
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
        </div>

        <h2>Your Testimonials</h2>
        {% for testimonial in testimonials %}
        <div class="testimonial-card">
            <div class="testimonial-header">
                <div class="author-info">
                    <span class="author-name">{{ testimonial.author_name }}</span>
                    <span class="stars">
                        {% for i in range(testimonial.rating) %}&#9733;{% endfor %}{% for i in range(5 - testimonial.rating) %}&#9734;{% endfor %}
                    </span>
                </div>
                {% if testimonial.status == 'approved' %}
                <span class="status status-approved">Approved</span>
                {% elif testimonial.status == 'pending' %}
                <span class="status status-pending">Pending</span>
                {% else %}
                <span class="status status-hidden">Hidden</span>
                {% endif %}
            </div>
            <div class="testimonial-content">
                <p>"{{ testimonial.content }}"</p>
            </div>
            <div class="actions">
                <a href="{{ url_for('approve_testimonial', testimonial_id=testimonial.id) }}" class="btn btn-secondary" style="background-color: var(--success-color); color: white;">Approve</a>
                <a href="{{ url_for('hide_testimonial', testimonial_id=testimonial.id) }}" class="btn btn-secondary">Hide</a>
                <a href="{{ url_for('delete_testimonial', testimonial_id=testimonial.id) }}" class="btn btn-logout">Delete</a>
            </div>
        </div>
        {% else %}
        <p>No testimonials submitted yet.</p>
        {% endfor %}
    </div>

    <!-- The Modal -->
    <div id="embed-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>How to Embed Your Wall</h2>
            <p>To display your testimonial wall on your website, simply copy the code below and paste it into an "HTML," "Code," or "Embed" block in your website editor (like WordPress, Squarespace, Wix, etc.).</p>
            <div class="form-group">
                <label for="embed-code" class="form-label">Your Embed Code</label>
                <div class="input-group">
                    <textarea id="embed-code" class="form-control" rows="4" readonly><iframe src="{{ url_for('show_wall', user_id=current_user.id, _external=True) }}" width="100%" height="600px" style="border:none;" title="Customer Testimonials"></iframe></textarea>
                    <button class="btn btn-secondary" onclick="copyToClipboard('embed-code')">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function copyToClipboard(elementId) {
            const input = document.getElementById(elementId);
            input.select();
            input.setSelectionRange(0, 99999); 
            try {
                document.execCommand('copy');
                alert('Copied!');
            } catch (err) {
                alert('Failed to copy. Please copy manually.');
            }
        }
        
        // Modal JavaScript
        var modal = document.getElementById("embed-modal");
        var btn = document.getElementById("embed-btn");
        var span = document.getElementsByClassName("close-button")[0];

        btn.onclick = function() {
            modal.style.display = "flex";
        }
        span.onclick = function() {
            modal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>

